name: "CD"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version of the release, e.g. 1.0.0"
        required: true

jobs:
  release:
    name: "Release"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_PAT }}

      - name: "Update the changelog"
        # Find the first line that starts with `###` or `## [<number>` from the CHANGELOG and insert the new version header before it.
        run: >
          current_date="$(date '+%Y-%m-%d')"
          && sed -i "0,/^\(###\|## *\[[0-9]\).*/{s//## [${{ github.event.inputs.version }}] - ${current_date}\n\n&/}" CHANGELOG.md

      - name: "Bump pyproject.toml to new version"
        run: sed -i 's/^version *=.*/version = "${{ github.event.inputs.version }}"/' pyproject.toml

      - name: "Extract version's changelog for release notes and tag message"
        # Find the lines between the first `## [<number>` and the second `## [<number>`.
        run: sed '1,/^## *\[[0-9]/d;/^## *\[[0-9]/Q' CHANGELOG.md > release_notes.txt

      - name: "Set up Python"
        id: setup-python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: "Install Poetry"
        uses: snok/install-poetry@5e4414407e59f94f2148bcb253917dfc22dee7d9  # v1.3.0
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: "Build the wheel"
        run: poetry build

      - name: "Publish to PyPI"
        run: poetry publish
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_TOKEN }}

      - name: "Commit and tag the changes"
        uses: EndBug/add-and-commit@8c12ff729a98cfbcd3fe38b49f55eceb98a5ec02  # v7.5.0
        with:
          add: '["pyproject.toml", "CHANGELOG.md"]'
          message: 'Release ${{ github.event.inputs.version }}'
          tag: 'v${{ github.event.inputs.version }} --annotate'
          default_author: github_actions

      - name: "Create a GitHub release"
        uses: softprops/action-gh-release@1e07f4398721186383de40550babbdf2b84acfc5  # v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: v${{ github.event.inputs.version }}
          body_path: release_notes.txt
